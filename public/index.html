<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>QR –û—Ç—á–∏—Ç–∞–Ω–µ ‚Äì –¶–µ–Ω—Ç—Ä–∞–ª–µ–Ω</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<style>
/* (—Å—Ç–∏–ª–æ–≤–µ—Ç–µ –æ—Å—Ç–∞–≤–∞—Ç —Å—ä—â–∏—Ç–µ –∫–∞—Ç–æ –ø—Ä–µ–¥–∏) */
body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:12px;max-width:980px;margin-left:auto;margin-right:auto}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}
h1,h2{margin:8px 0}
input,select,button,textarea{width:100%;padding:10px;margin-top:8px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box}
button{background:#0366d6;color:white;border:none}
.row{display:flex;gap:8px}
.col{flex:1}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
.small{font-size:0.9rem;color:#555}
.muted{color:#666;font-size:0.9rem}
</style>
</head>
<body>
  <h1>QR –û—Ç—á–∏—Ç–∞–Ω–µ ‚Äì –¶–µ–Ω—Ç—Ä–∞–ª–µ–Ω</h1>

  <div class="card">
    <h2>–ê–¥–º–∏–Ω (–º–µ–Ω–∏–¥–∂–º—ä–Ω—Ç)</h2>
    <div class="row">
      <div class="col"><input id="adminPass" placeholder="–í—ä–≤–µ–¥–∏ –∞–¥–º–∏–Ω –ø–∞—Ä–æ–ª–∞"></div>
      <div style="width:140px"><button id="btnAdminLogin">–í–ª–µ–∑</button></div>
      <div style="width:140px"><button id="btnAdminLogout" style="display:none;background:#e11;">–ò–∑—Ö–æ–¥</button></div>
    </div>
    <div id="adminArea" style="display:none;margin-top:10px">
      <h3>–ü—Ä–æ–µ–∫—Ç–∏</h3>
      <div class="row">
        <input id="newProject" placeholder="–ò–º–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç">
        <button id="btnAddProject">–î–æ–±–∞–≤–∏ –ø—Ä–æ–µ–∫—Ç</button>
      </div>
      <div id="projectsList" class="small muted"></div>

      <h3 style="margin-top:10px">–û–ø–µ—Ä–∞—Ç–æ—Ä–∏</h3>
      <div class="row">
        <input id="newUser" placeholder="–ò–º–µ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä">
        <button id="btnAddUser">–î–æ–±–∞–≤–∏</button>
      </div>
      <div id="usersList" class="small muted"></div>
    </div>
  </div>

  <div class="card">
    <h2>–ì–µ–Ω–µ—Ä–∏—Ä–∞–π QR –∑–∞ –ø—Ä–æ–µ–∫—Ç</h2>
    <div class="row">
      <select id="projForQR"></select>
      <div style="width:120px"><button id="btnGenQR">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button></div>
    </div>
    <div id="qrArea" style="margin-top:10px"></div>
    <div class="small muted">QR —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ —á—Ä–µ–∑ –ø—É–±–ª–∏—á–µ–Ω QR API –∏ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ —Å–≤–∞–ª–µ–Ω/—Ä–∞–∑–ø–µ—á–∞—Ç–∞–Ω.</div>
  </div>

  <div class="card">
    <h2>–û—Ç—á–∏—Ç–∞–Ω–µ (—Ä–∞–±–æ—Ç–Ω–∏—Ü–∏)</h2>
    <div class="row">
      <div class="col"><button id="btnStartScan">üì∑ –°—Ç–∞—Ä—Ç–∏—Ä–∞–π —Å–∫–µ–Ω–µ—Ä</button></div>
      <div style="width:120px"><button id="btnStopScan">–°–ø—Ä–∏</button></div>
    </div>
    <div id="cameraArea" style="margin-top:10px"></div>

    <div class="row" style="margin-top:8px">
      <div class="col"><select id="selectProject"></select></div>
      <div style="width:160px"><select id="selectOperator"></select></div>
    </div>

    <input id="inpQty" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <input id="inpTime" type="number" placeholder="–í—Ä–µ–º–µ (–º–∏–Ω—É—Ç–∏)">
    <textarea id="inpNotes" placeholder="–ë–µ–ª–µ–∂–∫–∏ (–ø–æ –∏–∑–±–æ—Ä)"></textarea>
    <div class="row">
      <div class="col"><button id="btnSave">–ó–∞–ø–∞–∑–∏ –æ—Ç—á–µ—Ç</button></div>
      <div style="width:160px"><button id="btnSendServer">–ò–∑–ø—Ä–∞—Ç–∏ –∏ –æ–±–Ω–æ–≤–∏</button></div>
    </div>
  </div>

  <div class="card">
    <h2>–û—Ç—á–µ—Ç–∏ / —Ñ–∏–ª—Ç—Ä–∏ / CSV</h2>
    <div class="row">
      <div class="col"><select id="filterProject"><option value="">–í—Å–∏—á–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏</option></select></div>
      <div style="width:160px"><input id="filterFrom" placeholder="–û—Ç (ISO: YYYY-MM-DD)"></div>
      <div style="width:160px"><input id="filterTo" placeholder="–î–æ (ISO: YYYY-MM-DD)"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><button id="btnFilter">–§–∏–ª—Ç—Ä–∏—Ä–∞–π</button></div>
      <div style="width:160px"><button id="btnExport">–ï–∫—Å–ø–æ—Ä—Ç CSV</button></div>
    </div>
    <div id="reportsArea" style="margin-top:10px"></div>
  </div>

<script>
const API_BASE = ""; // same origin

/* --------- Helpers for auth-aware fetch --------- */
function getToken(){ return localStorage.getItem('auth_token') || null; }
function authHeaders(){
  const t = getToken();
  return t ? { "Authorization": "Bearer " + t } : {};
}
async function apiGet(path, auth=false){
  const h = auth ? authHeaders() : {};
  const res = await fetch(API_BASE + path, { headers: { ...h } });
  if(!res.ok){
    const txt = await res.text();
    throw new Error(res.status + " " + txt);
  }
  return res.json();
}
async function apiPost(path, body, auth=false){
  const h = { "Content-Type":"application/json", ...(auth ? authHeaders() : {}) };
  const res = await fetch(API_BASE + path, { method:"POST", headers: h, body: JSON.stringify(body) });
  if(!res.ok){
    const txt = await res.text();
    throw new Error(res.status + " " + txt);
  }
  return res.json();
}

/* ---------- Admin login ---------- */
document.getElementById('btnAdminLogin').addEventListener('click', async ()=>{
  const pass = document.getElementById('adminPass').value || "";
  if(!pass) return alert('–í—ä–≤–µ–¥–µ—Ç–µ –ø–∞—Ä–æ–ª–∞');
  try{
    const r = await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ password: pass })});
    if(!r.ok){ const t = await r.text(); throw new Error(t || r.status); }
    const j = await r.json();
    localStorage.setItem('auth_token', j.token);
    document.getElementById('adminPass').value = '';
    showAdmin(true);
    await loadProjects(); await loadUsers(); loadReports();
    alert('–í–ª—è–∑–æ—Ö—Ç–µ –∫–∞—Ç–æ –∞–¥–º–∏–Ω');
  }catch(e){
    alert('–ì—Ä–µ—à–∫–∞: ' + e.message);
  }
});

document.getElementById('btnAdminLogout').addEventListener('click', ()=>{
  localStorage.removeItem('auth_token');
  showAdmin(false);
});

function showAdmin(on){
  document.getElementById('adminArea').style.display = on ? 'block' : 'none';
  document.getElementById('btnAdminLogout').style.display = on ? 'inline-block' : 'none';
}

/* ---------- Projects / Users ---------- */
async function loadProjects(){
  try{
    const projects = await apiGet('/projects');
    document.getElementById('selectProject').innerHTML = '<option value="">-- –∏–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>' + projects.map(x=>`<option>${x}</option>`).join('');
    document.getElementById('projForQR').innerHTML = projects.map(x=>`<option>${x}</option>`).join('');
    document.getElementById('filterProject').innerHTML = '<option value="">–í—Å–∏—á–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏</option>' + projects.map(x=>`<option>${x}</option>`).join('');
    document.getElementById('projectsList').innerText = projects.join('\n');
  }catch(e){ console.warn(e); }
}

document.getElementById('btnAddProject').addEventListener('click', async ()=>{
  const name = document.getElementById('newProject').value.trim();
  if(!name) return alert('–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ');
  try{
    await apiPost('/projects',{ name }, true); // protected
    document.getElementById('newProject').value='';
    await loadProjects();
    alert('–î–æ–±–∞–≤–µ–Ω –ø—Ä–æ–µ–∫—Ç');
  }catch(e){ alert('–ì—Ä–µ—à–∫–∞: ' + e.message); }
});

/* users */
async function loadUsers(){
  try{
    const users = await apiGet('/users');
    document.getElementById('selectOperator').innerHTML = '<option value="">-- –æ–ø–µ—Ä–∞—Ç–æ—Ä --</option>' + users.map(x=>`<option>${x}</option>`).join('');
    document.getElementById('usersList').innerText = users.join('\n');
  }catch(e){ console.warn(e); }
}
document.getElementById('btnAddUser').addEventListener('click', async ()=>{
  const name = document.getElementById('newUser').value.trim();
  if(!name) return alert('–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ');
  try{
    await apiPost('/users',{ name }, true); // protected
    document.getElementById('newUser').value='';
    await loadUsers();
    alert('–î–æ–±–∞–≤–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä');
  }catch(e){ alert('–ì—Ä–µ—à–∫–∞: ' + e.message); }
});

/* ---------- Generate QR ---------- */
document.getElementById('btnGenQR').addEventListener('click', ()=>{
  const val = document.getElementById('projForQR').value;
  if(!val) return alert('–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç');
  const url = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(val);
  const img = document.createElement('img'); img.src = url; img.style.maxWidth='240px';
  const area = document.getElementById('qrArea'); area.innerHTML=''; area.appendChild(img);
  const dl = document.createElement('a'); dl.href = url; dl.download = `QR-${val}.png`; dl.textContent = '–°–≤–∞–ª–∏ PNG'; dl.style.display='inline-block'; dl.style.marginLeft='10px';
  area.appendChild(dl);
});

/* ---------- Scanner ---------- */
let stream=null, videoEl=null, scanAnim=null;
document.getElementById('btnStartScan').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    videoEl = document.createElement('video'); videoEl.srcObject = stream; videoEl.autoplay=true; videoEl.playsInline=true;
    document.getElementById('cameraArea').innerHTML=''; document.getElementById('cameraArea').appendChild(videoEl);
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    const loop = ()=> {
      if(!videoEl) return;
      if(videoEl.readyState === videoEl.HAVE_ENOUGH_DATA){
        canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
        ctx.drawImage(videoEl,0,0);
        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(img.data, img.width, img.height);
        if(code && code.data){
          document.getElementById('selectProject').value = code.data;
          stopScan();
          return;
        }
      }
      scanAnim = requestAnimationFrame(loop);
    };
    loop();
  }catch(e){ alert('–ù–µ –º–æ–∂–µ –¥–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∫–∞–º–µ—Ä–∞: '+e.message); }
});
document.getElementById('btnStopScan').addEventListener('click', stopScan);
function stopScan(){ if(stream) stream.getTracks().forEach(t=>t.stop()); stream=null; if(videoEl){ videoEl.remove(); videoEl=null; } if(scanAnim) cancelAnimationFrame(scanAnim); document.getElementById('cameraArea').innerHTML=''; }

/* ---------- Save report ---------- */
document.getElementById('btnSave').addEventListener('click', async ()=>{
  const project = document.getElementById('selectProject').value;
  const operator = document.getElementById('selectOperator').value;
  const qty = document.getElementById('inpQty').value;
  const time = document.getElementById('inpTime').value;
  const notes = document.getElementById('inpNotes').value;
  if(!project) return alert('–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç (–∏–ª–∏ —Å–∫–∞–Ω–∏—Ä–∞–π—Ç–µ QR)');
  try{
    await apiPost('/save',{ project, qty, time, operator, notes }, false);
    alert('–ó–∞–ø–∏—Å–∞–Ω–æ.');
    loadReports();
  }catch(e){ alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: ' + e.message); }
});

/* ---------- Reports / filters / export ---------- */
async function loadReports(){
  const qproj = document.getElementById('filterProject').value;
  const from = document.getElementById('filterFrom').value || '';
  const to = document.getElementById('filterTo').value || '';
  const params = new URLSearchParams();
  if(qproj) params.append('project',qproj);
  if(from) params.append('from',from);
  if(to) params.append('to',to);
  try{
    const data = await apiGet('/data?' + params.toString());
    const area = document.getElementById('reportsArea');
    if(!data.length){ area.innerHTML='<div class="small muted">–ù—è–º–∞ –∑–∞–ø–∏—Å–∏</div>'; return; }
    let html = '<table><thead><tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th><th>–ö–æ–ª</th><th>–í—Ä–µ–º–µ</th><th>–ë–µ–ª–µ–∂–∫–∏</th></tr></thead><tbody>';
    data.forEach(r=>{ html += `<tr><td>${new Date(r.date).toLocaleString()}</td><td>${r.project}</td><td>${r.operator||''}</td><td>${r.qty||''}</td><td>${r.time||''}</td><td>${r.notes||''}</td></tr>`; });
    html += '</tbody></table>';
    area.innerHTML = html;
  }catch(e){ console.warn(e); }
}
document.getElementById('btnFilter').addEventListener('click', loadReports);
document.getElementById('btnExport').addEventListener('click', async ()=>{
  const qproj = document.getElementById('filterProject').value;
  const from = document.getElementById('filterFrom').value || '';
  const to = document.getElementById('filterTo').value || '';
  const params = new URLSearchParams();
  if(qproj) params.append('project',qproj);
  if(from) params.append('from',from);
  if(to) params.append('to',to);
  // export requires admin token
  const t = getToken();
  if(!t) return alert('–¢—Ä—è–±–≤–∞ –¥–∞ –≤–ª–µ–∑–µ—Ç–µ –∫–∞—Ç–æ –∞–¥–º–∏–Ω –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç.');
  window.location = '/export?' + params.toString() + '&_token=1'; // token validated server-side via header
  try{
    // attempt direct fetch to include header (modern browsers block setting headers on navigation),
    // so we rely on server-side verifyToken middleware; user should be logged in.
    // Alternatively, we could do fetch and create Blob, but this is simpler.
  }catch(e){ console.warn(e); }
});

/* ---------- Init ---------- */
(async function init(){
  // if token present, show admin area
  if(getToken()) showAdmin(true);
  await loadProjects();
  await loadUsers();
  loadReports();
})();
</script>
</body>
</html>
