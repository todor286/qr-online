<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>QR –û—Ç—á–∏—Ç–∞–Ω–µ ‚Äì –¶–µ–Ω—Ç—Ä–∞–ª–µ–Ω</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;padding:12px;max-width:980px;margin-left:auto;margin-right:auto}
  .card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}
  h1,h2{margin:8px 0}
  input,select,button,textarea{width:100%;padding:10px;margin-top:8px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box}
  button{background:#0366d6;color:white;border:none}
  .row{display:flex;gap:8px}
  .col{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  .small{font-size:0.9rem;color:#555}
  .muted{color:#666;font-size:0.9rem}
</style>
</head>
<body>
  <h1>QR –û—Ç—á–∏—Ç–∞–Ω–µ ‚Äì –¶–µ–Ω—Ç—Ä–∞–ª–µ–Ω</h1>

  <div class="card">
    <h2>–ê–¥–º–∏–Ω (–º–µ–Ω–∏–¥–∂–º—ä–Ω—Ç)</h2>
    <div class="row">
      <div class="col"><input id="adminPass" placeholder="–í—ä–≤–µ–¥–∏ –∞–¥–º–∏–Ω –ø–∞—Ä–æ–ª–∞ (–∑–∞ –ø—Ä–æ–º–µ–Ω–∏)"></div>
      <div style="width:140px"><button id="btnAdminLogin">–í–ª–µ–∑</button></div>
    </div>
    <div id="adminArea" style="display:none;margin-top:10px">
      <h3>–ü—Ä–æ–µ–∫—Ç–∏</h3>
      <div class="row">
        <input id="newProject" placeholder="–ò–º–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç">
        <button id="btnAddProject">–î–æ–±–∞–≤–∏ –ø—Ä–æ–µ–∫—Ç</button>
      </div>
      <div id="projectsList" class="small muted"></div>

      <h3 style="margin-top:10px">–û–ø–µ—Ä–∞—Ç–æ—Ä–∏</h3>
      <div class="row">
        <input id="newUser" placeholder="–ò–º–µ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä">
        <button id="btnAddUser">–î–æ–±–∞–≤–∏</button>
      </div>
      <div id="usersList" class="small muted"></div>
    </div>
  </div>

  <div class="card">
    <h2>–ì–µ–Ω–µ—Ä–∏—Ä–∞–π QR –∑–∞ –ø—Ä–æ–µ–∫—Ç</h2>
    <div class="row">
      <select id="projForQR"></select>
      <div style="width:120px"><button id="btnGenQR">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button></div>
    </div>
    <div id="qrArea" style="margin-top:10px"></div>
    <div class="small muted">QR —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ —á—Ä–µ–∑ –ø—É–±–ª–∏—á–µ–Ω QR API –∏ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ —Å–≤–∞–ª–µ–Ω/—Ä–∞–∑–ø–µ—á–∞—Ç–∞–Ω.</div>
  </div>

  <div class="card">
    <h2>–û—Ç—á–∏—Ç–∞–Ω–µ (—Ä–∞–±–æ—Ç–Ω–∏—Ü–∏)</h2>
    <div class="row">
      <div class="col"><button id="btnStartScan">üì∑ –°—Ç–∞—Ä—Ç–∏—Ä–∞–π —Å–∫–µ–Ω–µ—Ä</button></div>
      <div style="width:120px"><button id="btnStopScan">–°–ø—Ä–∏</button></div>
    </div>
    <div id="cameraArea" style="margin-top:10px"></div>

    <div class="row" style="margin-top:8px">
      <div class="col"><select id="selectProject"></select></div>
      <div style="width:160px"><select id="selectOperator"></select></div>
    </div>

    <input id="inpQty" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <input id="inpTime" type="number" placeholder="–í—Ä–µ–º–µ (–º–∏–Ω—É—Ç–∏)">
    <textarea id="inpNotes" placeholder="–ë–µ–ª–µ–∂–∫–∏ (–ø–æ –∏–∑–±–æ—Ä)"></textarea>
    <div class="row">
      <div class="col"><button id="btnSave">–ó–∞–ø–∞–∑–∏ –æ—Ç—á–µ—Ç</button></div>
      <div style="width:160px"><button id="btnSendServer">–ò–∑–ø—Ä–∞—Ç–∏ –∏ –æ–±–Ω–æ–≤–∏</button></div>
    </div>
  </div>

  <div class="card">
    <h2>–û—Ç—á–µ—Ç–∏ / —Ñ–∏–ª—Ç—Ä–∏ / CSV</h2>
    <div class="row">
      <div class="col"><select id="filterProject"><option value="">–í—Å–∏—á–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏</option></select></div>
      <div style="width:160px"><input id="filterFrom" placeholder="–û—Ç (ISO: YYYY-MM-DD)"></div>
      <div style="width:160px"><input id="filterTo" placeholder="–î–æ (ISO: YYYY-MM-DD)"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><button id="btnFilter">–§–∏–ª—Ç—Ä–∏—Ä–∞–π</button></div>
      <div style="width:160px"><button id="btnExport">–ï–∫—Å–ø–æ—Ä—Ç CSV</button></div>
    </div>
    <div id="reportsArea" style="margin-top:10px"></div>
  </div>

<script>
/* ---------- Helper network ---------- */
const API_BASE = ""; // same origin

async function apiGet(path){
  const res = await fetch(API_BASE + path);
  return res.json();
}
async function apiPost(path, body){
  const res = await fetch(API_BASE + path, {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
  });
  return res;
}

/* ---------- Admin logic ---------- */
const adminPassInput = document.getElementById('adminPass');
const adminArea = document.getElementById('adminArea');
document.getElementById('btnAdminLogin').addEventListener('click', ()=>{
  const p = adminPassInput.value || "";
  // We simply store it in memory (the server expects header x-admin-pass or body.admin_pass)
  window.__ADMIN_PASS = p;
  adminArea.style.display = p ? 'block' : 'none';
  if(p) loadProjects(); loadUsers();
});

/* ---------- Projects / Users management ---------- */
async function loadProjects(){
  const projects = await apiGet('/projects');
  const s1 = document.getElementById('selectProject');
  const s2 = document.getElementById('projForQR');
  const s3 = document.getElementById('filterProject');
  s1.innerHTML = '<option value="">-- –∏–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>' + projects.map(x=>`<option>${x}</option>`).join('');
  s2.innerHTML = projects.map(x=>`<option>${x}</option>`).join('');
  s3.innerHTML = '<option value="">–í—Å–∏—á–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏</option>' + projects.map(x=>`<option>${x}</option>`).join('');
  document.getElementById('projectsList').innerText = projects.join('\n');
}
document.getElementById('btnAddProject').addEventListener('click', async ()=>{
  const name = document.getElementById('newProject').value.trim();
  if(!name) return alert('–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ');
  const res = await fetch('/projects',{method:'POST',headers:{'Content-Type':'application/json','x-admin-pass': window.__ADMIN_PASS || ''},body:JSON.stringify({name})});
  if(res.ok){ document.getElementById('newProject').value=''; loadProjects(); alert('–î–æ–±–∞–≤–µ–Ω –ø—Ä–æ–µ–∫—Ç'); }
  else { const t = await res.text(); alert('–ì—Ä–µ—à–∫–∞: '+t); }
});

/* users */
async function loadUsers(){
  const users = await apiGet('/users');
  document.getElementById('selectOperator').innerHTML = '<option value="">-- –æ–ø–µ—Ä–∞—Ç–æ—Ä --</option>' + users.map(x=>`<option>${x}</option>`).join('');
  document.getElementById('usersList').innerText = users.join('\n');
}
document.getElementById('btnAddUser').addEventListener('click', async ()=>{
  const name = document.getElementById('newUser').value.trim();
  if(!name) return alert('–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ');
  const res = await fetch('/users',{method:'POST',headers:{'Content-Type':'application/json','x-admin-pass': window.__ADMIN_PASS || ''},body:JSON.stringify({name})});
  if(res.ok){ document.getElementById('newUser').value=''; loadUsers(); alert('–î–æ–±–∞–≤–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä'); }
  else { const t = await res.text(); alert('–ì—Ä–µ—à–∫–∞: '+t); }
});

/* ---------- Generate QR ---------- */
document.getElementById('btnGenQR').addEventListener('click', ()=>{
  const val = document.getElementById('projForQR').value;
  if(!val) return alert('–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç');
  const url = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(val);
  const img = document.createElement('img'); img.src = url; img.style.maxWidth='240px';
  const area = document.getElementById('qrArea'); area.innerHTML=''; area.appendChild(img);
  const dl = document.createElement('a'); dl.href = url; dl.download = `QR-${val}.png`; dl.textContent = '–°–≤–∞–ª–∏ PNG'; dl.style.display='inline-block'; dl.style.marginLeft='10px';
  area.appendChild(dl);
});

/* ---------- Scanner (worker) ---------- */
let stream=null, videoEl=null, scanAnim=null;
document.getElementById('btnStartScan').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    videoEl = document.createElement('video'); videoEl.srcObject = stream; videoEl.autoplay=true; videoEl.playsInline=true;
    document.getElementById('cameraArea').innerHTML=''; document.getElementById('cameraArea').appendChild(videoEl);
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    const loop = ()=> {
      if(!videoEl) return;
      if(videoEl.readyState === videoEl.HAVE_ENOUGH_DATA){
        canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
        ctx.drawImage(videoEl,0,0);
        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(img.data, img.width, img.height);
        if(code && code.data){
          document.getElementById('selectProject').value = code.data;
          stopScan();
          return;
        }
      }
      scanAnim = requestAnimationFrame(loop);
    };
    loop();
  }catch(e){ alert('–ù–µ –º–æ–∂–µ –¥–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∫–∞–º–µ—Ä–∞: '+e.message); }
});
document.getElementById('btnStopScan').addEventListener('click', stopScan);
function stopScan(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream = null; if(videoEl){ videoEl.remove(); videoEl=null; }
  if(scanAnim) cancelAnimationFrame(scanAnim);
  document.getElementById('cameraArea').innerHTML='';
}

/* ---------- Save report ---------- */
document.getElementById('btnSave').addEventListener('click', async ()=>{
  const project = document.getElementById('selectProject').value;
  const operator = document.getElementById('selectOperator').value;
  const qty = document.getElementById('inpQty').value;
  const time = document.getElementById('inpTime').value;
  const notes = document.getElementById('inpNotes').value;
  if(!project) return alert('–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç (–∏–ª–∏ —Å–∫–∞–Ω–∏—Ä–∞–π—Ç–µ QR)');
  await apiPost('/save',{ project, qty, time, operator, notes });
  alert('–ó–∞–ø–∏—Å–∞–Ω–æ (–ª–æ–∫–∞–ª–Ω–æ –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞).');
  loadReports();
});

/* ---------- Reports / filters / export ---------- */
async function loadReports(){
  const qproj = document.getElementById('filterProject').value;
  const from = document.getElementById('filterFrom').value || '';
  const to = document.getElementById('filterTo').value || '';
  const params = new URLSearchParams();
  if(qproj) params.append('project',qproj);
  if(from) params.append('from',from);
  if(to) params.append('to',to);
  const data = await apiGet('/data?' + params.toString());
  const area = document.getElementById('reportsArea');
  if(!data.length){ area.innerHTML='<div class="small muted">–ù—è–º–∞ –∑–∞–ø–∏—Å–∏</div>'; return; }
  let html = '<table><thead><tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th><th>–ö–æ–ª</th><th>–í—Ä–µ–º–µ</th><th>–ë–µ–ª–µ–∂–∫–∏</th></tr></thead><tbody>';
  data.forEach(r=>{
    html += `<tr><td>${new Date(r.date).toLocaleString()}</td><td>${r.project}</td><td>${r.operator||''}</td><td>${r.qty||''}</td><td>${r.time||''}</td><td>${r.notes||''}</td></tr>`;
  });
  html += '</tbody></table>';
  area.innerHTML = html;
}
document.getElementById('btnFilter').addEventListener('click', loadReports);
document.getElementById('btnExport').addEventListener('click', ()=>{
  const qproj = document.getElementById('filterProject').value;
  const from = document.getElementById('filterFrom').value || '';
  const to = document.getElementById('filterTo').value || '';
  const params = new URLSearchParams();
  if(qproj) params.append('project',qproj);
  if(from) params.append('from',from);
  if(to) params.append('to',to);
  window.location = '/export?' + params.toString();
});

/* ---------- Init ---------- */
(async function init(){
  await loadProjects();
  await loadUsers();
  loadReports();
})();
</script>
</body>
</html>

